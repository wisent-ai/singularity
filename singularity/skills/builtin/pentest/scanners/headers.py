"""Security headers scanner â€” missing headers, CORS misconfig, cookie issues, info disclosure."""

from typing import Dict, List

import httpx

from ..constants import (
    SECURITY_HEADERS,
    INFO_DISCLOSURE_HEADERS,
    SEVERITY_HIGH,
    SEVERITY_MEDIUM,
    SEVERITY_LOW,
    SEVERITY_INFO,
    make_finding,
)


async def scan_headers(client: httpx.AsyncClient, url: str) -> List[Dict]:
    """Run all header checks against *url*."""
    resp = await client.get(url, follow_redirects=True)
    headers = {k.lower(): v for k, v in resp.headers.items()}
    findings: List[Dict] = []

    # Missing security headers
    for header_key, meta in SECURITY_HEADERS.items():
        if header_key not in headers:
            findings.append(make_finding(
                title=f"Missing {meta['name']} header",
                severity=meta["severity"],
                category="headers",
                description=f"The {meta['name']} ({header_key}) header is not set.",
                remediation=meta["remediation"],
                owasp=meta["owasp"],
            ))

    # CORS
    acao = headers.get("access-control-allow-origin", "")
    if acao == "*":
        findings.append(make_finding(
            title="Wildcard CORS policy",
            severity=SEVERITY_MEDIUM,
            category="headers",
            description="Access-Control-Allow-Origin is '*', allowing any origin.",
            evidence=f"access-control-allow-origin: {acao}",
            remediation="Restrict CORS to trusted origins.",
            owasp="A05:2021 Security Misconfiguration",
        ))
    acac = headers.get("access-control-allow-credentials", "")
    if acac.lower() == "true" and acao and acao != "*":
        findings.append(make_finding(
            title="CORS allows credentials with reflected origin",
            severity=SEVERITY_HIGH,
            category="headers",
            description="CORS allows credentials while reflecting Origin, enabling cross-site data theft.",
            evidence=f"allow-origin: {acao}, allow-credentials: {acac}",
            remediation="Do not reflect arbitrary origins when Allow-Credentials is true.",
            owasp="A05:2021 Security Misconfiguration",
        ))

    # Cookies
    for cookie in resp.cookies.jar:
        name = cookie.name
        if not cookie.secure and resp.url.scheme == "https":
            findings.append(make_finding(
                title=f"Cookie '{name}' missing Secure flag",
                severity=SEVERITY_MEDIUM,
                category="cookies",
                description=f"Cookie '{name}' is served over HTTPS but lacks the Secure attribute.",
                remediation="Add Secure flag to all cookies served over HTTPS.",
                owasp="A05:2021 Security Misconfiguration",
            ))
        samesite = getattr(cookie, "samesite", None) or ""
        if not samesite:
            findings.append(make_finding(
                title=f"Cookie '{name}' missing SameSite attribute",
                severity=SEVERITY_LOW,
                category="cookies",
                description=f"Cookie '{name}' does not set the SameSite attribute.",
                remediation="Set SameSite=Strict or SameSite=Lax on all cookies.",
                owasp="A05:2021 Security Misconfiguration",
            ))

    # Info disclosure headers
    for h in INFO_DISCLOSURE_HEADERS:
        if h in headers:
            findings.append(make_finding(
                title=f"Information disclosure via '{h}' header",
                severity=SEVERITY_INFO,
                category="headers",
                description=f"The '{h}' header reveals: {headers[h]}",
                evidence=f"{h}: {headers[h]}",
                remediation=f"Remove or suppress the '{h}' response header.",
                owasp="A05:2021 Security Misconfiguration",
            ))

    return findings
