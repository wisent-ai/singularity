"""Shared constants, payloads, and helpers for pentest scanners."""

from typing import Dict, List, Optional

# ---------------------------------------------------------------------------
# Severity levels (aligned with CVSS 3.1 qualitative ratings)
# ---------------------------------------------------------------------------
SEVERITY_CRITICAL = "critical"  # CVSS 9.0-10.0
SEVERITY_HIGH = "high"          # CVSS 7.0-8.9
SEVERITY_MEDIUM = "medium"      # CVSS 4.0-6.9
SEVERITY_LOW = "low"            # CVSS 0.1-3.9
SEVERITY_INFO = "info"          # CVSS 0.0

SEVERITY_CVSS = {
    SEVERITY_CRITICAL: 9.5,
    SEVERITY_HIGH: 7.5,
    SEVERITY_MEDIUM: 5.0,
    SEVERITY_LOW: 2.0,
    SEVERITY_INFO: 0.0,
}


def make_finding(
    title: str,
    severity: str,
    category: str,
    description: str,
    evidence: str = "",
    remediation: str = "",
    owasp: str = "",
    cvss: Optional[float] = None,
) -> Dict:
    """Create a standardised finding dict."""
    return {
        "title": title,
        "severity": severity,
        "cvss": cvss if cvss is not None else SEVERITY_CVSS.get(severity, 0.0),
        "category": category,
        "description": description,
        "evidence": evidence[:500],
        "remediation": remediation,
        "owasp": owasp,
    }


# ---------------------------------------------------------------------------
# Security headers checklist
# ---------------------------------------------------------------------------
SECURITY_HEADERS = {
    "strict-transport-security": {
        "name": "HSTS",
        "severity": SEVERITY_MEDIUM,
        "remediation": "Add Strict-Transport-Security header with max-age >= 31536000 and includeSubDomains.",
        "owasp": "A05:2021 Security Misconfiguration",
    },
    "content-security-policy": {
        "name": "CSP",
        "severity": SEVERITY_MEDIUM,
        "remediation": "Implement a Content-Security-Policy that restricts script-src and object-src.",
        "owasp": "A05:2021 Security Misconfiguration",
    },
    "x-frame-options": {
        "name": "X-Frame-Options",
        "severity": SEVERITY_LOW,
        "remediation": "Set X-Frame-Options to DENY or SAMEORIGIN (or use CSP frame-ancestors).",
        "owasp": "A05:2021 Security Misconfiguration",
    },
    "x-content-type-options": {
        "name": "X-Content-Type-Options",
        "severity": SEVERITY_LOW,
        "remediation": "Set X-Content-Type-Options: nosniff.",
        "owasp": "A05:2021 Security Misconfiguration",
    },
    "referrer-policy": {
        "name": "Referrer-Policy",
        "severity": SEVERITY_LOW,
        "remediation": "Set Referrer-Policy to strict-origin-when-cross-origin or no-referrer.",
        "owasp": "A05:2021 Security Misconfiguration",
    },
    "permissions-policy": {
        "name": "Permissions-Policy",
        "severity": SEVERITY_LOW,
        "remediation": "Set Permissions-Policy to restrict camera, microphone, geolocation, etc.",
        "owasp": "A05:2021 Security Misconfiguration",
    },
}

INFO_DISCLOSURE_HEADERS = [
    "server",
    "x-powered-by",
    "x-aspnet-version",
    "x-aspnetmvc-version",
    "x-generator",
]

# ---------------------------------------------------------------------------
# SQL injection payloads (error-based, time-based, boolean-based)
# ---------------------------------------------------------------------------
SQLI_ERROR_PAYLOADS = [
    "'",
    "\"",
    "' OR '1'='1",
    "\" OR \"1\"=\"1",
    "'; --",
    "1' AND 1=CONVERT(int,@@version)--",
]

SQLI_ERROR_SIGNATURES = [
    "you have an error in your sql syntax",
    "unclosed quotation mark",
    "quoted string not properly terminated",
    "pg_query",
    "mysql_fetch",
    "sqlite3.operationalerror",
    "ora-01756",
    "microsoft ole db",
    "odbc sql server driver",
    "syntax error",
    "sql syntax",
    "warning: mysql",
    "valid mysql result",
    "mysqlclient",
    "sqlstate",
]

SQLI_TIME_PAYLOADS = [
    "' OR SLEEP(3)--",
    "'; WAITFOR DELAY '0:0:3'--",
    "' OR pg_sleep(3)--",
]

SQLI_BOOLEAN_PAYLOADS = [
    ("' OR '1'='1'--", "' OR '1'='2'--"),
    ("\" OR \"1\"=\"1\"--", "\" OR \"1\"=\"2\"--"),
]

# ---------------------------------------------------------------------------
# XSS canary payloads
# ---------------------------------------------------------------------------
XSS_CANARIES = [
    {"payload": "<script>alert('XSS')</script>", "canary": "<script>alert('XSS')</script>"},
    {"payload": "<img src=x onerror=alert(1)>", "canary": "onerror=alert(1)"},
    {"payload": "'\"><svg onload=alert(1)>", "canary": "onload=alert(1)"},
    {"payload": "javascript:alert(1)", "canary": "javascript:alert(1)"},
    {"payload": "<body onload=alert(1)>", "canary": "onload=alert(1)"},
]

# ---------------------------------------------------------------------------
# Sensitive paths (Next.js / Vercel / general web)
# ---------------------------------------------------------------------------
SENSITIVE_PATHS = [
    # Environment / config
    "/.env",
    "/.env.local",
    "/.env.production",
    "/.env.development",
    # Git
    "/.git/config",
    "/.git/HEAD",
    # Next.js specific
    "/_next/data",
    "/api/health",
    "/api/auth/session",
    "/_next/static/chunks/app",
    # Admin / debug
    "/admin",
    "/admin/login",
    "/_debug",
    "/graphql",
    "/api/graphql",
    # Source maps
    "/main.js.map",
    "/bundle.js.map",
    "/static/js/main.js.map",
    "/_next/static/chunks/main.js.map",
    # Common leaks
    "/robots.txt",
    "/sitemap.xml",
    "/.well-known/security.txt",
    "/package.json",
    "/composer.json",
    "/wp-config.php",
    "/server-status",
    "/phpinfo.php",
    "/.DS_Store",
    "/backup.sql",
    "/dump.sql",
    "/.htaccess",
    "/web.config",
    "/swagger.json",
    "/api-docs",
    "/openapi.json",
]


# ---------------------------------------------------------------------------
# Form / input discovery helper
# ---------------------------------------------------------------------------
def discover_inputs(html: str, base_url: str) -> List[Dict]:
    """Parse HTML for forms and input fields using BeautifulSoup."""
    try:
        from bs4 import BeautifulSoup
    except ImportError:
        return []

    soup = BeautifulSoup(html, "html.parser")
    inputs: List[Dict] = []

    for form in soup.find_all("form"):
        action = form.get("action", "")
        method = form.get("method", "get").upper()
        fields = []
        for inp in form.find_all(["input", "textarea", "select"]):
            name = inp.get("name")
            if name:
                fields.append({
                    "name": name,
                    "type": inp.get("type", "text"),
                    "tag": inp.name,
                })
        if fields:
            inputs.append({
                "action": action,
                "method": method,
                "fields": fields,
            })

    return inputs
